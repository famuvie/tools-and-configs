#!/usr/bin/env python
# -*- coding: <encoding name> -*-

import logging
import argparse
import sys
import yaml
from os.path import expanduser

# Logger (better than print)
logging.basicConfig(
    level=logging.INFO,
    format=' %(asctime)s - %(levelname)s - %(message)s',
    datefmt='%I:%M:%S %p')
logger = logging.getLogger('4SQ Import')

# Parsing arguments
home = expanduser("~")
parser = argparse.ArgumentParser(description='Loads a CARTO user into your environment')
parser.add_argument('user', type=str,
                    help='Name of the user to load')
parser.add_argument('--config', dest='config_file',
                    default=home+'/.cartorc.yaml',
                    help='Configuration file to read, defaults to ~/.cartorc.yaml)')
try:
    logger.debug('Parsing...')
    args = parser.parse_args()
    logger.debug('Load config...')
    with open(args.config_file,'r') as f:
        config = yaml.load(f.read())
        if args.user in config:
            user_config = config[args.user]
            user =  user_config['user']
            api_key = user_config['api_key']

            if 'url' in user_config:
                 url = user_config['url']
            else:
                url = 'https://{}.carto.com/api'.format(user)

            print('''
export CARTO_USER={}
export CARTO_API_KEY={}
export CARTO_API_URL={}'''.format(user,api_key,url))

        else:
            raise Exception('User not found on config')

except Exception as e:
    logger.error(e.message)
    sys.exit(1)
finally:
    sys.exit(0)

